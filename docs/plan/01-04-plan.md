# Refactoring Plan: TRD 01-04 T3C-Style Report System

## Overview

This plan covers the implementation of a comprehensive T3C-style interactive report system, including new JSON API response structures, visualization data generation, API endpoint updates, and substantive message filtering validation.

## Source Documents

- `01-json-api-structure.md` - JSON API Response Structure Design
- `02-visualization-data.md` - Visualization Data in Report Pipeline
- `03-api-endpoints.md` - API Endpoint Updates
- `04-message-filtering.md` - Substantive Message Filtering in Output

## Tasks

### Phase 1: Type Definitions (TRD 01)

[x] task1 - Add T3CReport and related type definitions to src/types/report.ts
[x] task2 - Add VisualizationData types (ScatterPlotData, TopicTreeData, ChartData) to src/types/report.ts
[x] task3 - Add ReportMetadata interface with scope and filtering information
[x] task4 - Add Topic and Opinion interfaces for the new report structure
[x] task5 - Add MessageRef interface for message references in topics

### Phase 2: Visualization Data Generator (TRD 02)

[x] task6 - Create src/services/reportPipeline/visualizer.ts with scatter plot generation
[x] task7 - Add topic tree generation to visualizer.ts
[x] task8 - Add chart data generation (sentiment, categories, topics, timeline) to visualizer.ts
[x] task9 - Export VisualizerResult interface and generateVisualizationData function

### Phase 3: Pipeline Integration (TRD 01, 02)

[x] task10 - Integrate visualizer step into report pipeline index.ts
[x] task11 - Update Report interface to include visualization data
[x] task12 - Update STEPS constant to include visualization step

### Phase 4: Report Transformer Utility (TRD 03)

[x] task13 - Create src/utils/reportTransformer.ts with transformToT3CFormat function
[x] task14 - Implement topic transformation with sentiment distribution
[x] task15 - Implement metadata generation with processing time and scope

### Phase 5: API Endpoint Updates (TRD 03)

[x] task16 - Update GET /api/reports/:jobId to support format query parameter
[x] task17 - Add GET /api/reports/:jobId/topics endpoint
[x] task18 - Add GET /api/reports/:jobId/visualization endpoint
[x] task19 - Add GET /api/reports/:jobId/statistics endpoint

### Phase 6: Message Filtering Validation (TRD 04)

[x] task20 - Create src/utils/reportValidator.ts with validation functions
[x] task21 - Integrate validation into report pipeline
[x] task22 - Add enhanced categorizer logging for filtering breakdown

## Build Verification

[x] Run TypeScript build check (`source ~/.nvm/nvm.sh && nvm use 22 && npx tsc --noEmit`)

## Notes

- Maintain backward compatibility by keeping existing Report interface and markdown field
- All new types should be exported from src/types/report.ts
- Visualization generation should complete in < 500ms for performance
- Message filtering validation should throw error if non-substantive messages are found in output
- API format parameter defaults to "json" but supports "markdown" and "full"
